---
- name: Group hosts by it_service and send emails
  hosts: localhost
  gather_facts: no
  vars:
    groups_to_process: []

  tasks:
    - name: Gather host information
      add_host:
        name: "{{ inventory_hostname }}"
        groupname: "{{ item }}"
      loop: "{{ groups_to_process }}"
      when: "'undefined' not in item"

    - name: Group hosts by it_service
      set_fact:
        groups_to_process: >-
          {{ groups_to_process + [
              (item.0|default('')) + '_' + item.1.it_service|default('')
            ] | unique
          }}
      loop: "{{ query('hostvars', 'item', groups_to_process) }}"
      register: grouped_hosts

    - name: Debug groups and associated hosts
      debug:
        var: grouped_hosts

    - name: Send email for each group
      include_tasks: send_email.yml
      loop: "{{ grouped_hosts.results }}"
      loop_control:
        label: "{{ item.0 }}"
